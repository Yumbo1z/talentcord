<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" type="icon" href="https://i.imgur.com/Bxj4aaT.png" />
  <title>Talentcord</title>
  <link href="https://fonts.googleapis.com/css?family=Fira+Sans" rel="stylesheet" />
  <link rel="stylesheet" href="https://site-assets.fontawesome.com/releases/v6.1.1/css/all.css" />

  <link type="text/css" rel="stylesheet" href="/css" />
  <style>
    textarea {
      margin-top: 10px;
      width: 100%;
      min-height: 5rem;
      resize: none;
      box-sizing: border-box;
      padding: 8px;
      font-size: 1rem;
      border: 2px solid #383a40;
      border-radius: 5px;
      background-color: #383a40;
      color: #ccc;
      max-width: 100%;
    }

    textarea:focus {
      outline: none;
    }

    .about-wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      margin-top: 25px;
      margin-bottom: 25px;
      width: 100%;
      max-width: 700px;
      margin-left: auto;
      margin-right: auto;
    }

    .about {
      font-size: 2rem;
      word-break: break-word;
    }

    .about-buttons {
      margin-top: 25px;
      margin-bottom: 25px;
      display: flex;
      justify-content: center;
      gap: 10px;
      flex-wrap: wrap;
      width: 100%;
    }

    .about-button {
      display: inline-flex;
      padding: 10px 20px;
      font-size: 1rem;
      border-radius: 5px;
      background-color: #5865f2;
      color: #fff;
      border: none;
      cursor: pointer;
      transition: background-color 0.2s;
      margin: 5px 0;
      flex: 1 1 120px;
      max-width: 200px;
      text-align: center;
    }

    .about-button:hover {
      background-color: #4752c4;
    }

    .listings {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      justify-content: center;
      margin: 20px auto;
      width: 100%;
      max-width: 1200px;
    }

    .listing-card, .post-card {
      background: #36393f;
      border-radius: 10px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      padding: 20px;
      width: 100%;
      max-width: 350px;
      box-sizing: border-box;
      display: flex;
      flex-direction: row;
      align-items: center;
      gap: 15px;
      cursor: pointer;
      transition: box-shadow 0.2s;
    }

    .listing-card:hover, .post-card:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }

    .avatar {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      object-fit: cover;
      max-width: 100%;
      flex-shrink: 0;
    }

    .listing-info {
      flex: 1 1 auto;
      min-width: 0;
    }

    .profile-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }

    .badge-icons {
      display: flex;
      gap: 5px;
      flex-wrap: wrap;
    }

    .tags {
      display: flex;
      gap: 5px;
      flex-wrap: wrap;
      margin-top: 5px;
    }

    .tag {
      background: #5865f2;
      color: #fff;
      border-radius: 3px;
      padding: 2px 8px;
      font-size: 0.85rem;
      margin-right: 2px;
    }

    @media (max-width: 600px) {
      .about {
        font-size: 1.2rem;
      }
      .about-wrapper {
        padding: 0 10px;
      }
      .about-button {
        font-size: 0.95rem;
        padding: 8px 10px;
        max-width: 120px;
      }
      .listing-card, .post-card {
        padding: 12px;
        max-width: 100%;
        flex-direction: column;
        align-items: flex-start;
      }
      .avatar {
        width: 40px;
        height: 40px;
      }
    }

    @media (min-width: 700px) {
      .listings {
        gap: 30px;
      }
      .listing-card, .post-card {
        max-width: 350px;
      }
      .about-wrapper {
        max-width: 900px;
      }
    }

    @media (min-width: 1024px) {
      .listings {
        max-width: 1400px;
      }
      .about {
        font-size: 2.5rem;
      }
      .about-wrapper {
        max-width: 1200px;
      }
    }
  </style>
</head>

<body>
  <!-- Navbar -->
  <nav class="navbar">
    <div class="logo">Talentcord</div>
    <div class="search-bar">
      <input type="text" placeholder="Search for a user..." />
    </div>
    <div class="plus-icon" onclick="openModal('signInModal', 'block')">
      <i class="fas fa-plus"></i>
    </div>
  </nav>

  <section class="welcome">
    <div class="about-wrapper">
      <h1 class="about">Find the right talent. Get hired faster.</h1>
      <p>
        Your one-stop hub for engaging discussions, powerful tools, and an
        amazing community.
      </p>
      <div class="about-buttons">
        <button onclick="location.href = 'https://truthsocial.com/@talentcord';" class="about-button">
          Truth
        </button>
        <button onclick="location.href = 'https://discord.gg/EQXNyxVYDb';" class="about-button">
          Join the Community!
        </button>
        <button onclick="location.href = 'https://x.com/realtalentcord';" class="about-button">
          X
        </button>
        <button onclick="location.href = 'https://www.youtube.com/@Talentcord';" class="about-button">
          Youtube
        </button>
      </div>

      <div class="about-buttons">
        <button onclick="location.href = '/plans';" class="about-button">
          Plans
        </button>
      </div>
    </div>
  </section>

  <!-- Listings -->
  <section class="listings" id="listings"></section>

  <div class="context-menu" id="customContextMenu">
    <button onclick="banUser()">Ban</button>
    <button onclick="timeoutUser()">Timeout</button>
    <div class="dropdown">
      <button class="dropdown-button">Give Badge</button>
      <div class="dropdown-content">
        <button onclick="givemod()">Give Mod Badge</button>
        <button onclick="givedev()">Give Dev Badge</button>
        <button onclick="giveverified()">Give Verified Badge</button>
      </div>
    </div>
  </div>

  <section class="welcome">
    <div class="about-wrapper">
      <h1 class="about">Posts</h1>
      <p>
        Share a brief and compelling header to catch the attention of
        potential recruiters.
      </p>
      <div class="about-buttons">
        <button id="open-post" class="about-button">Post Something!</button>
      </div>
    </div>
  </section>

  <form id="postdiv" class="post-form">
    <div class="post-content">
      <p style="font-size: 18px; color: #fff;">
        ⚠️ keep tos in mind when you post.
      </p>
      <textarea name="postContent" form="postdiv"
        placeholder="Hello I am an experienced backend dev looking for work..." required></textarea>
      <button type="submit" id="post-now" class="about-button">
        Post Now
      </button>
      <button onclick="closeModal('postdiv')" class="about-button">
        Cancel
      </button>
    </div>
  </form>

  <form id="postjobdiv" class="post-form">
    <div class="post-content">
      <p style="font-size: 18px; color: #fff;">
        ⚠️ keep tos in mind when you post a job listing.
      </p>
      <textarea name="content" form="postjobdiv"
        placeholder="Hello I'm looking for an experienced backend dev to help me with my website..."
        required></textarea>
      <button type="submit" id="post-job-now" class="about-button">
        Post Now
      </button>
      <button onclick="closeModal('postjobdiv')" class="about-button">
        Cancel
      </button>
    </div>
  </form>

  <!-- posts -->
  <section class="listings" id="posts"></section>

  <!-- job posts -->
  <section class="listings" id="job-posts"></section>

  <div class="context-menu" id="postContextMenu">
    <button onclick="banUser()">Ban</button>
    <button onclick="timeoutUser()">Timeout</button>
    <button onclick="deletePost()">Delete Post</button>
  </div>

  <div class="footer">
    <p>&copy; <span id="current-year">2025</span> Talentcord. All rights reserved. | <a href="/privacy">Privacy
        Policy</a> | <a href="/terms">Terms of Service</a>
    </p>
  </div>

  <!-- Sign In Modal -->
  <div id="signInModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('signInModal')">&times;</span>
      <form id="signin-form" onsubmit="postSignIn(event)">
        <h2>Sign In</h2>
        <label for="signin-username">Username:</label>
        <input type="text" id="signin-username" required />

        <label for="signin-password">Password:</label>
        <input type="password" id="signin-password" required />

        <button type="submit">Sign In</button>
      </form>
      <p style="margin-top: 10px;">
        Don't have an account?
        <a href="/sign-up">Create one here.</a>
      </p>
    </div>
  </div>

  <!-- Edit Profile Modal -->
  <div id="editProfileModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('editProfileModal')">&times;</span>
      <form id="edit-profile-form" onsubmit="postEditProfile(event)">
        <h2>Edit Profile</h2>
        <label for="edit-bio">Bio:</label>
        <textarea id="edit-bio"></textarea>

        <label for="edit-portfolio">Portfolio URL:</label>
        <input type="text" id="edit-portfolio" required />

        <label for="edit-avatar">Avatar</label>
        <input type="file" id="imageInput" name="avatar" accept="image/png, image/jpeg" />

        <label for="edit-tags">Select Tags:</label><br />
        <div id="tags-container-ep"
          style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; margin-top: 20px;">
          <button type="button" class="tag-button" data-value="#developer">
            #developer
          </button>
          <button type="button" class="tag-button" data-value="#designer">
            #designer
          </button>
          <button type="button" class="tag-button" data-value="#writer">
            #writer
          </button>
          <button type="button" class="tag-button" data-value="#graphic">
            #graphic
          </button>
          <button type="button" class="tag-button" data-value="#copywriter">
            #copywriter
          </button>
          <button type="button" class="tag-button" data-value="#devops">
            #devops
          </button>
          <button type="button" class="tag-button" data-value="#community-management">
            #community-management
          </button>
          <button type="button" class="tag-button" data-value="#artist">
            #artist
          </button>
          <button type="button" class="tag-button" data-value="#digital-artist">
            #digital-artist
          </button>
          <button type="button" class="tag-button" data-value="#manga-artist">
            #manga-artist
          </button>
          <button type="button" class="tag-button" data-value="#moderator">
            #moderator
          </button>
        </div>

        <button type="submit">Update Profile</button>
        <button onclick="signout()" style="margin-top: 10px;">
          Sign Out
        </button>
      </form>
    </div>
  </div>

  <!-- Cropper -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>

  <!-- Upload Avatar -->
  <script>
    const imageInput = document.getElementById("imageInput");
    var cropperImage = document.getElementById("AvatarImage");

    // Function to handle file selection
    imageInput.addEventListener("change", (event) => {
      const file = event.target.files[0];
      const reader = new FileReader();
      reader.onload = (e) => {
        cropperImage.src = e.target.result;
        modal.style.display = "block"; // Display the modal
        initCropper(); // Initialize the cropper
      };
      reader.readAsDataURL(file);
    });
    // Function to initialize the cropper
    function initCropper() {
      var cropper = new Cropper(cropperImage, {
        aspectRatio: 1, // Set aspect ratio for cropping (1:1 for a circle avatar)
        viewMode: 1, // Display the cropped area within the container
        crop: function (event) {
          // Callback function when cropping is done
          // You can retrieve the cropped data here
        },
      });

      // Event listener for the crop button
      cropButton.addEventListener("click", function () {
        // Get the cropped canvas

        var croppedCanvas = cropper.getCroppedCanvas({
          width: 200, // Set width of the cropped image
          height: 200, // Set height of the cropped image
        });

        // Convert the cropped canvas data to a blob
        croppedCanvas.toBlob(async (blob) => {
          // Create a FormData object
          var formData = new FormData();
          // Append the cropped image blob to the FormData object
          formData.append("avatar", blob);
          formData.append("token", "$$token$$");

          // Use fetch to send the cropped image data to the upload-profile-img endpoint
          const response = await fetch("/upload-profile-img", {
            method: "POST",
            body: formData,
          });

          const responseData = await response.json();
          if (response.ok) {
            showToast(responseData.success, "green");
          } else {
            showToast(responseData.error, "red");
          }
        });

        // Close the modal after cropping
        modal.style.display = "none";
      });

      // Event listener for the close button
      var closeButton = document.getElementsByClassName("close")[0];
      closeButton.addEventListener("click", function () {
        modal.style.display = "none"; // Close the modal
      });

      // Event listener for clicks outside the modal
      window.onclick = function (event) {
        if (event.target == modal) {
          modal.style.display = "none"; // Close the modal if clicked outside
        }
      };
    }
  </script>
  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      let response = await fetch("/users");
      let json = await response.json();
      const listings = document.getElementById("listings");

      const currentUser = JSON.parse(localStorage.getItem("user"));

      for (let user of json) {
        let tags = user.tags
          .map((tag) => `<span class="tag">${tag}</span>`)
          .join(" ");

        // Map badges to Font Awesome icons
        let badges = user.badges
          .map((badge) => {
            return `<div class="badge-container">
                <i class="${badge.faClass} badge-icon"></i>
                <span class="badge-tooltip">${badge.name}</span>
              </div>`;
          })
          .join("");

        listings.innerHTML += `
    <div class="listing-card" data-user="${user.username}" data-perms="${user.permissions}" onclick="window.location='/profile/${user.username}'">
      <img src="${user.icon}" alt="User Avatar" class="avatar">
      <div class="listing-info">
        <div class="profile-header">
          <h3>${user.username}</h3>
          <div class="badge-icons">
            ${badges}
          </div>
        </div>
        <p>${user.bio}</p>
        <div class="tags">${tags}</div>
      </div>
    </div>`;
      }

      document.querySelectorAll(".listing-card").forEach((card) => {
        card.addEventListener("contextmenu", (event) => {
          event.preventDefault();
          if (currentUser) {
            let currentUserMoreData = json.find(
              (v) => v.username === currentUser.username
            );
            if (currentUserMoreData.permissions === 1) showContextMenu(event, card);
          }
        });
      });

      refreshPosts();
    });

    //post
    document.getElementById("open-post").addEventListener("click", (e) => {
      if (!localStorage.user) {
        e.preventDefault();
        alert("Sign in to post!");
      } else {
        openModal("postdiv", "flex");
      }
    });

    const form = document.getElementById("postdiv");
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      document.getElementById("post-now").disabled = true;
      const data = Object.fromEntries(new FormData(form).entries());
      const userData = JSON.parse(localStorage.getItem("user"));
      const response = await fetch("/post", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          data: { content: data.postContent, token: userData.token },
        }),
      });

      if (response.ok) {
        const successData = await response.json();
        alert(successData.success);
        document.getElementById("post-now").disabled = false;
        closeModal("postdiv");
        refreshPosts();
      } else {
        const errorData = await response.json();
        alert(errorData.error);
        document.getElementById("post-now").disabled = false;
      }
    });

    async function refreshPosts() {
      let response = await fetch("/posts");
      let json = await response.json();
      const posts = document.getElementById("posts");

      // Clear the existing posts before adding new ones
      posts.innerHTML = "";

      const currentUser = JSON.parse(localStorage.getItem("user"));

      for (let post of json) {
        // Map badges to Font Awesome icons
        let badges = post.badges
          .map((badge) => {
            return `<div class="badge-container">
                <i class="${badge.faClass} badge-icon"></i>
                <span class="badge-tooltip">${badge.name}</span>
              </div>`;
          })
          .join("");

        posts.innerHTML += `
    <div class="post-card" data-user="${post.username}" data-perms="${post.permissions}" data-id="${post._id}">
      <img src="${post.icon}" alt="User Avatar" class="avatar">
      <div class="listing-info">
        <div class="profile-header">
          <h3><a style="color: white;" href="${post.portfolio}" onclick="confirmExit(event, '${post.portfolio}')" target="_blank">${post.username}</a></h3>
          <div class="badge-icons">
            ${badges}
          </div>
        </div>
        <p>${post.content}</p>
      </div>
    </div>`;
      }

      document.querySelectorAll(".post-card").forEach((card) => {
        card.addEventListener("contextmenu", (event) => {
          event.preventDefault();
          if (currentUser) {
            let currentUserMoreData = json.find(
              (v) => v.username === currentUser.username
            );
            if (currentUserMoreData.permissions === 1)
              showPostContextMenu(event, card);
          }
        });
      });
    }

  </script>

  <script src="/client"></script>
  <script src="/mod"></script>

</body>

</html>